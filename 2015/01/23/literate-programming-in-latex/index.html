<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>在 LaTeX 中进行文学编程 | 始终</title>
  <meta name="author" content="Liam Huang">
  
  <meta name="description" content="Liam&#39;s Blog | Liam Huang&#39;s Blog | Liam | Huang | Python | LaTeX | C++ | Java | GRE | TOEFL">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta property="og:title" content="在 LaTeX 中进行文学编程"/>
  <meta property="og:site_name" content="始终"/>

  <link rel="alternate" href="/atom.xml" title="始终" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!-- 尝试从 bdimg 获取 JQuery -->
  <script src="http://apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
  <!-- 如果获取失败，则载入本站的 JQuery -->
  <script type="text/javascript">
  //<![CDATA[
  if (typeof jQuery == 'undefined') {
    document.write(unescape("%3Cscript src='/js/jquery-2.0.3.min.js' type='text/javascript'%3E%3C/script%3E"));
  }
  // ]]>
  </script>
  <script type="text/javascript" src="http://tajs.qq.com/stats?sId=45037302" charset="UTF-8"></script>

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44836433-1', 'liam0205.me');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>


  <!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</head>


<body>
  <div class="wrapper">
    <header id="header"><div class="title">
  <h1><a href="/">始终</a></h1>
  <a href="/">不忘初心</a>
</div>
<!--
<div>
<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
 <input style="width:60px;background-color:transparent;text-align:center; border-width:0px;border-top-style: none; border-right-style: none; border-left-style: none; border-bottom-style: none; "  type="search" name="q" id="search" autocomplete="off" autocorrect="off" autocapitalize="off" maxlength="20" placeholder="s" />
 <input type="hidden" name="q" value="site:liam0205.me">
</form>
</div>
-->
<nav class="nav">
  <ul>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/links">链接</a></li>
    
      <li><a href="/about">关于</a></li>
    
      <li><a href="http://collect.liam0205.me">文摘</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <time datetime="2015-01-23T07:48:35.000Z"><a href="/2015/01/23/literate-programming-in-latex/">2015 年 01 月 23 日</a></time>
    
    
  
    <h1 class="title">在 LaTeX 中进行文学编程</h1>
  

  </header>
  
  <div class="entry">
    
      <p>文学编程是 TeX 的作者高德纳提出的编程方式，主张程序员在编写代码的过程中详细地记录自己的思维方式和内在逻辑。</p>
<p>这种编程方式注重编码的逻辑而将编码本身放在更次要的位置，因而不充分的设计在这种变成方式下无所遁形。文学编程的另一个优点是它产生的代码文档能帮助程序员在任意时候重新会想起当时编码的思路。</p>
<p>在 LaTeX 中，可以用 Doc 和 DocStrip 这两个工具来实现文学编程。</p>
<a id="more"></a>

<p>对于程序员来说，最重要的有三个部分：</p>
<ul>
<li>代码；</li>
<li>代码文档；</li>
<li>用户手册。</li>
</ul>
<p>使用 Doc 和 DocStrip 可以将这三个部分集中到一个 <code>.dtx</code> 文件当中。这篇文章将分三个部分讲述如何构建这样一个 <code>.dtx</code> 文件。</p>
<h2 id="-ins_ 文件 "><code>.ins</code> 文件</h2>
<p>INS 三个字母是「Install」的缩写，顾名思义，这个文件是和安装相关的。<code>.ins</code> 文件通常用来控制 TeX 从 <code>.dtx</code> 文件里释放宏包文件，它的结构最为简单，大概是这样的。</p>
<ol>
<li>作为注释的版权信息</li>
<li><strong>载入 <code>docstrip.tex</code></strong></li>
<li>写入 DocStrip 的控制命令</li>
<li>编写将写入生成文件的版权信息</li>
<li><strong>生成文件指令</strong></li>
<li>写入提示信息用以完成安装</li>
<li><strong>结束安装文件</strong></li>
</ol>
<p>这里粗体标记的是必不可少的部分，其他部分或多或少都可以省略。</p>
<p>我们逐步构建一个完整的 <code>.ins</code> 文件。</p>
<hr>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="comment">%% Copyright (C) 2003--2015</span>
<span class="comment">%% CTEX.ORG and any individual authors listed elsewhere in this file.</span>
<span class="comment">%% --------------------------------------------------------------------------</span>
<span class="comment">%%</span>
<span class="comment">%% This work may be distributed and/or modified under the</span>
<span class="comment">%% conditions of the LaTeX Project Public License, either</span>
<span class="comment">%% version 1.3c of this license or (at your option) any later</span>
<span class="comment">%% version. This version of this license is in</span>
<span class="comment">%%    http://www.latex-project.org/lppl/lppl-1-3c.txt</span>
<span class="comment">%% and the latest version of this license is in</span>
<span class="comment">%%    http://www.latex-project.org/lppl.txt</span>
<span class="comment">%% and version 1.3 or later is part of all distributions of</span>
<span class="comment">%% LaTeX version 2005/12/01 or later.</span>
<span class="comment">%%</span>
<span class="comment">%% This work has the LPPL maintenance status `maintained'.</span>
<span class="comment">%%</span>
<span class="comment">%% The Current Maintainers of this work are Leo Liu, Qing Lee and Liam Huang.</span>
<span class="comment">%% --------------------------------------------------------------------------</span>
</pre></td></tr></table></figure>



<p>这是 <code>ctex</code> 宏包的版权声明信息。</p>
<ul>
<li>这里的每一行都以百分号开头，因此在声明版权的同时不会影响正常的编译流程。</li>
<li>版权声明部分，首先是声明版权的归属。</li>
<li>接下来，声明许可协议为 LPPL。大多数 TeX 相关的宏包或软件，都在 LPPL 协议下发布。</li>
</ul>
<hr>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="command">\input</span> docstrip.tex
</pre></td></tr></table></figure>



<p>载入 <code>docstrip.tex</code>。</p>
<hr>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="command">\keepsilent</span>
</pre></td></tr></table></figure>



<p>这是 DocStrip 的控制命令之一，其作用是关闭 DocStrip 的日志输出功能。默认情况下，DocStrip 会详细输出它的每一步操作。对于大多数人来说，成百上千行的日志徒惹人嫌弃，因此我们关闭它。</p>
<p>更多的控制命令可以参考 DocStrip 的文档。</p>
<hr>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="command">\preamble</span>

    Copyright (C) 2003-2015
    CTEX.ORG and any individual authors listed in the documentation.
------------------------------------------------------------------------------

    This work may be distributed and/or modified under the
    conditions of the LaTeX Project Public License, either
    version 1.3c of this license or (at your option) any later
    version. This version of this license is in
       http://www.latex-project.org/lppl/lppl-1-3c.txt
    and the latest version of this license is in
       http://www.latex-project.org/lppl.txt
    and version 1.3 or later is part of all distributions of
    LaTeX version 2005/12/01 or later.

    This work has the LPPL maintenance status `maintained'.

    The Current Maintainers of this work are Leo Liu, Qing Lee and Liam Huang.
------------------------------------------------------------------------------

<span class="command">\endpreamble</span>
</pre></td></tr></table></figure>



<p>在 <code>\preamble</code> 和 <code>\endpreamble</code> 之间的部分，将被写入由 DocStrip 生成的所有文档（默认情况下）。比如上面这段 <code>ctex</code> 宏包的版权信息将写入每一个生成的文件。</p>
<hr>
<p>下面的内容是整个 <code>.ins</code> 文件里最重要的部分，它控制着如何生成最终的宏包文件。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="command">\generate</span>
  <span class="special">{</span>
    <span class="command">\usedir</span><span class="special">{</span>tex/latex/ctex<span class="special">}</span>
    <span class="command">\file</span><span class="special">{</span>ctex.sty<span class="special">}</span>                 <span class="special">{</span><span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span><span class="special">{</span>package,style<span class="special">}</span><span class="special">}</span>
    <span class="command">\file</span><span class="special">{</span>ctexcap.sty<span class="special">}</span>              <span class="special">{</span><span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span><span class="special">{</span>package,ctexcap<span class="special">}</span><span class="special">}</span>
    <span class="command">\file</span><span class="special">{</span>ctexsize.sty<span class="special">}</span>             <span class="special">{</span><span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span><span class="special">{</span>package,ctexsize<span class="special">}</span><span class="special">}</span>
    <span class="command">\file</span><span class="special">{</span>ctexart.cls<span class="special">}</span>              <span class="special">{</span><span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span><span class="special">{</span>class,article<span class="special">}</span><span class="special">}</span>
    <span class="command">\file</span><span class="special">{</span>ctexbook.cls<span class="special">}</span>             <span class="special">{</span><span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span><span class="special">{</span>class,book<span class="special">}</span><span class="special">}</span>
    <span class="command">\file</span><span class="special">{</span>ctexrep.cls<span class="special">}</span>              <span class="special">{</span><span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span><span class="special">{</span>class,report<span class="special">}</span><span class="special">}</span>
    <span class="command">\file</span><span class="special">{</span>ctexspa.def<span class="special">}</span>
      <span class="special">{</span>
        <span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span>         <span class="special">{</span>ctexspa<span class="special">}</span>
        <span class="command">\from</span><span class="special">{</span>ctexpunct.spa<span class="special">}</span>        <span class="special">{</span><span class="special">}</span>
      <span class="special">}</span>
  <span class="special">}</span>
</pre></td></tr></table></figure>



<p><code>\generate</code> 命令中的<code>\file{⟨filename⟩}{\from{⟨sourcefilename⟩}{⟨optionlist⟩}}</code> 用来指定宏包文件的生成方式。这里的含义是，从 <code>⟨sourcefilename⟩</code> 中抽取含有 <code>⟨optionlist⟩</code> 标记的部分，生成 <code>⟨filename⟩</code> 这个文件。</p>
<p>一个 <code>\generate</code> 里可以有多个 <code>\file</code> 命令。一个 <code>\file</code> 命令里可以有多个 <code>\from</code> 命令。一个 <code>\from</code> 命令里的 <code>⟨option⟩</code>，组成 <code>⟨optionlist⟩</code>。其中 <code>⟨option⟩</code> 需要用逗号隔开，<code>\file</code> 之间和 <code>\from</code> 之间则不需要。</p>
<hr>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="command">\obeyspaces</span>
<span class="command">\Msg</span><span class="special">{</span>*************************************************************<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*                                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>* To finish the installation you have to move the following *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>* file into proper directories searched by TeX:             *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*                                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>* The recommended directory is TDS:tex/latex/ctex           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*                                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*     ctex.sty                                              *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*     ctexcap.sty                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*     ctexsize.sty                                          *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*     ctexart.cls                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*     ctexbook.cls                                          *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*     ctexrep.cls                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*     ctexspa.def                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*                                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>* To produce the documentation run the file ctex.dtx        *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>* through XeLaTeX.                                          *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*                                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>* Happy TeXing!                                             *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*                                                           *<span class="special">}</span>
<span class="command">\Msg</span><span class="special">{</span>*************************************************************<span class="special">}</span>
</pre></td></tr></table></figure>



<p>这里的内容会在处理完 <code>.ins</code> 文件之后显示在控制台，用来提示使用者将文件置入指定的目录。TeX 会忽略连续的空格，第一行的 <code>\obeyspaces</code> 则会让 TeX 输出这些空格。</p>
<hr>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="command">\endbatchfile</span>
</pre></td></tr></table></figure>



<p>显式地结束安装文件，此后的所有内容都会被忽略。</p>
<p>将上面的代码依次粘贴到一起，就是一个最简单的 <code>.ins</code> 文件了。</p>
<h2 id="-dtx_ 文件 "><code>.dtx</code> 文件</h2>
<p><code>.dtx</code> 文件比 <code>.ins</code> 文件复杂得多。<code>.ins</code> 文件在整个过程中会被读取一次，而 <code>.dtx</code> 文件却会被读取三次。下面是对此三个步骤的简略描述。如果暂时看不懂也没有关系，下一节我们将会化身人肉编译器，逐行分析示例。</p>
<p>处理 <code>.ins</code> 文件的时候，会载入 <code>.dtx</code> 文件。这时候 <code>.dtx</code> 文件中以 <code>%</code> 开头的行将被全部忽略，而以 <code>%</code> 开头的行则会用于记录 <code>⟨option⟩</code>。程序会根据 <code>.ins</code> 文件中 <code>\generate</code> 命令里 <code>\from</code> 的指示的 <code>⟨option⟩</code> 抽取 <code>.dtx</code> 文件中 <code>⟨option⟩</code> 相关内容。这个过程中，没有以 <code>%</code> 开头的行会根据 <code>⟨option⟩</code> 写入文件，而 <code>%</code> 开头的行则被抑制并保护起来。最终生成宏包文件。</p>
<p>第二遍处理 <code>.dtx</code> 文件的时候，在读入 <code>\documentclass{ltxdoc}</code> 之前，所有的内容与通常意义上的 LaTeX 代码完全一致。因此需要依靠 <code>\iffalse</code> 和 <code>% \iffalse</code> 来保护相关代码，这些代码通常是 README 文件和 LICENSE 文件。在读入 <code>\DocInput{filename.dtx}</code> 之后，<code>.dtx</code> 文件会被第三次载入处理。处理完成之后遇到 <code>\end{document}</code>，后续的内容被全部忽略。最终生成说明文档。</p>
<p>第三遍处理 <code>.dtx</code> 是被 <code>\DocInput</code> 载入的。此时，文档内（几乎）所有的 <code>%</code> 都被忽略。因为 LaTeX 只能有一个 <code>\documentclass</code> 以及一对 <code>\begin{document}</code> 和 <code>\end{document}</code>，所以 <code>\end{document}</code> 之前的所有内容都应当在这一次处理的时候被忽略。因此这部分内容应该被 <code>\iffalse</code> 和 <code>\fi</code> 保护起来。</p>
<p><code>.dtx</code> 文件由以下部分组成。</p>
<ol>
<li>包含在 <code>% \iffalse</code> 和 <code>% \fi</code> 中间的版权信息</li>
<li><strong>包含在 <code>% \iffalse</code> 和 <code>% \fi</code> 中间的宏包基本信息</strong></li>
<li><strong>包含在 <code>%&lt;*driver&gt;</code> 和 <code>%&lt;/driver&gt;</code> 中间的 <code>ltxdoc</code> 文档类及相关代码，这部分代码也应包含在 <code>% \iffalse</code> 和 <code>% \fi</code> 中间</strong></li>
<li><strong>在 <code>\end{document}</code> 之后的说明文档，这部分文档应该隐藏在行首的 <code>%</code> 之后</strong></li>
<li><strong>在说明文档最后的代码说明，以及间杂在代码说明中间的代码，其中代码说明也应该隐藏在行首的 <code>%</code> 之后，而代码本身则不应该被 <code>%</code> 保护</strong></li>
</ol>
<p>示例 <code>.dtx</code> 文件的具体内容，可以参看下一节。</p>
<h2 id=" 人肉编译器 ">人肉编译器</h2>
<p>我们来看两个文件，分别是 <a href="/attachment/LaTeX-useful-tools/dtxtut/dtxtut.ins"><code>dtxtut.ins</code></a> 和 <a href="/attachment/LaTeX-useful-tools/dtxtut/dtxtut.dtx"><code>dtxtut.dtx</code></a>。你可以下载这两个文件，然后跟着我的思路一起分析。</p>
<p>首先我们要生成宏包文件，在命令行中运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>xelatex dtxtut.ins
</pre></td></tr></table></figure>



<p>注意，这里的后缀名不可省略。</p>
<p>文件读入之后，直到 12 行都是注释，直接忽略。接着到了第 13 行，读入了 <code>docstrip.tex</code> 这个文件。随后进行了一些设置之后来到了第 26 行.</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="command">\generate</span><span class="special">{</span><span class="command">\file</span><span class="special">{</span><span class="command">\jobname</span>.sty<span class="special">}</span><span class="special">{</span><span class="command">\from</span><span class="special">{</span><span class="command">\jobname</span>.dtx<span class="special">}</span><span class="special">{</span>package<span class="special">}</span><span class="special">}</span><span class="special">}</span>
</pre></td></tr></table></figure>



<p>这里 <code>\jobname</code> 是当前文件的名字（不含后缀），即 <code>dtxtut</code>。所以这里会从 <code>dtxtut.dtx</code> 文件中，抽取 <code>package</code> 的部分，组成名为 <code>dtxtut.sty</code> 这个文件。</p>
<p>现在我们读取 <code>dtxtut.dtx</code>。前 18 行都是注释，忽略。19 — 21 行是 <code>package</code> 部分，输出。23 行开始了名为 <code>driver</code> 的部分，直到 32 行结束。接下来一直到 81 行都是注释，忽略。82 行开始了名为 <code>package</code> 的部分，于是程序将 82 行开始到 100 行中没有注释掉的部分抽出来，输出。这样，输出的内容接在 <code>\preamble</code> 之后，保存为 <code>dtxtut.sty</code> 文件。</p>
<p>接下来我们生成宏包文档，在命令行中运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>xelatex dtxtut.dtx
</pre></td></tr></table></figure>



<p>同样，这里的后缀名不可省略。</p>
<p>前 23 行都是注释，忽略。24 行载入了 <code>ltxdoc</code> 文档类，随后载入了刚刚生成的 <code>dtxtut.sty</code> 宏包。26 行的 <code>\EnableCrossrefs</code> 打开了代码索引的生成（如果你将来不需要，可以用 <code>\DisableCrossrefs</code> 打开）。27 行的 <code>\CodelineIndex</code> 则使得索引指向代码行号，而不是页码。28 行的 <code>\RecordChanges</code> 则会让文档类记录宏包的变化记录。</p>
<p>接下来，30 行的 <code>\DocInput{\jobname.dtx}</code> 重新载入了这个文件本身，但（几乎）所有的 <code>%</code> 符号都被忽略。第 1 行遇到 <code>\iffalse</code>，直到 16 行的 <code>\fi</code>，中间的内容都被忽略。17 行是空行。18 行又遇到 <code>\iffalse</code>，直到 33 行的 <code>\fi</code>，中间的内容都被忽略。注意，这里正好跳过了 <code>driver</code> 部分。</p>
<p>接下来的 <code>\CheckSum</code> 和 <code>\CharacterTable</code> 是为了检测 <code>.dtx</code> 文件完整性的两个工具。众所周知，<code>.dtx</code> 文件包含了一个宏包的几乎所有信息，如果文件在网络传输的过程中出错，则宏包安装必然失败。因此，检测文件的完整性就变得很有必要。</p>
<p><code>\CheckSum</code> 采用了一个很简单的方案来检验完整性。它将从 <code>\StopEventually</code> 开始到 <code>\Finale</code> 结尾的，在 <code>macrocode</code> 环境里的反斜杠 <code>\</code> 计数，将计数的值作为校验和。在生成文档的过程中，程序将会计算这个值，并于 <code>\CheckSum{}</code> 中的值进行比对。若二者不一致，则说明传输过程中可能出现错误。</p>
<p><code>\CharacterTable</code> 更为直接一点。程序将检查代码中出现的符号均包含在 <code>\CharacterTable</code> 之中。若不然，则认为传输过程中可能出错。</p>
<p>接下来的内容，直到第 76 行都很好理解。77 行出现了 <code>\StopEventually</code> 命令，并在参数中启动了 <code>\PrintIndex</code> 命令。我们刚才说了 <code>\StopEventually</code> 会开启校验和的检查，而 <code>\PrintIndex</code> 则会在此处打印代码索引。</p>
<p><code>macrocode</code> 环境是一个特殊的环境，它有点类似于 LaTeX 原生的 <code>verbatim</code> 环境。它在大多数情况下的行为和 <code>verbatim</code> 环境相同，大体上是将代码输出到最终的文档当中。</p>
<p>这样持续运行到 103 行，遇到 <code>\Finale</code> 命令，校验和计算的终点。此时，程序将会计算出校验和，并与文档中给出的校验和进行比较。如果 <code>\CheckSum</code> 不存在，或者给出的值为 <code>0</code>，那么程序会给出正确的值，让你填入文档。如果 <code>\CheckSum</code> 存在，但值与程序计算的不符，那么程序会报错，并给出正确的值。改正后重新编译才能得到文档。如果 <code>\CheckSum</code> 存在，且校验和通过，那么程序会继续运行。</p>
<p>104 行是 <code>\endinput</code>，结束整个文件，本次对 <code>dtxtut.dtx</code> 的处理结束，回到上一次的断点。</p>
<p>30 行之后，31 行就是 <code>\end{document}</code>，文档处理结束，之后的内容全都被忽略。输出文档，退出。</p>
<h2 id=" 将 _-dtx_ 和 _-ins_ 合二为一 ">将 <code>.dtx</code> 和 <code>.ins</code> 合二为一</h2>
<p>细心的读者会发现，整个过程中，<code>.dtx</code> 文件承担了几乎所有的功能，而 <code>.ins</code> 文件只是一个「指路人」。这些读者可能会思考，是不是有办法将 <code>.ins</code> 文件并入 <code>.dtx</code> 文件呢？答案是肯定的。</p>
<p>对于这类合二为一的 <code>.dtx</code> 文件，使用 Plain TeX 格式编译，会启动 DocStrip 工具，得到宏包文件；使用 LaTeX 格式编译，则会生成文档。</p>
<p>这里给出一个来自<a href="http://www.zhihu.com/question/27693438" target="_blank">知乎提问</a>的<a href="/attachment/LaTeX-useful-tools/dtxtut/insdtxtut.dtx">示例</a>（略有修改），你可以在<a href="http://www.zhihu.com/question/27693438/answer/37669407" target="_blank">我的答案</a>里看到对此的具体分析。</p>
<h2 id=" 最后的最后 ">最后的最后</h2>
<p>今天是 W 的生日。祝你生日快乐~</p>

      <hr>
<h3 id=" 捐助 ">您的鼓励是我写作最大的动力</h3>
<p>
俗话说，投资效率是最成功的投资。
如果您感觉我的文章质量不错，读后收获很大，感觉能为您提高 10% 的工作效率，不妨小额捐助我一下，让我有动力继续写出更多好文章。
</p>
<img src="/attachment/images/Liam-Alipay-small.png" height = "120" width = "120" alt="用支付宝手机客户端扫描二维码小额捐助" />

    
  </div>
  <footer>
    
      <div class="bdsharebuttonbox bdshare-button-style0-16" data-bd-bind="1406015473860">
        <a href="#" class="bds_more" data-cmd="more"></a>
        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
        <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
        <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
        <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
        <a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
      </div>
      <!--
      <div class="tags">
        <span id="container_page_counter">
        您是本文第 <span id="value_page_counter"></span> 位读者
        </span>
      </div>
      -->
      
  
  <div class="categories">
    <a href="/categories/LaTeX/">LaTeX</a>
  </div>

      
  
  <div class="tags">
    <a href="/tags/Literate Programming/">Literate Programming</a>, <a href="/tags/dtx/">dtx</a>, <a href="/tags/Macro/">Macro</a>
  </div>

    
    <div class="clearfix"></div>
  </footer>
</article>


<!-- wumii Button BEGIN -->
<div style="margin:0px auto; padding-left:23px; text-align:center;">
	
	

	<script type="text/javascript" id="wumiiRelatedItems"></script>
	<script type="text/javascript">
		var wumiiPermaLink  = "http://liam0205.me/2015/01/23/literate-programming-in-latex/"; //请用代码生成文章永久的链接
		var wumiiTitle      = "在 LaTeX 中进行文学编程"; //请用代码生成文章标题
		var wumiiTags       = "Literate Programming, dtx, Macro"; //请用代码生成文章标签，以英文逗号分隔，如："标签1,标签2"
		var wumiiCategories = ["LaTeX"]; //请用代码生成文章分类，分类名放在 JSONArray 中，如: ["分类1", "分类2"]
		var wumiiSitePrefix = "http://liam0205.me/";
		var wumiiParams     = "&num=5&mode=3&pf=JAVASCRIPT";
	</script>
	<script type="text/javascript" src="http://widget.wumii.cn/ext/relatedItemsWidget"></script>
	<!--
	<a href="http://www.wumii.com/widget/relatedItems" style="border:0;">
	    <img src="http://static.wumii.cn/images/pixel.png" alt="无觅关联推荐，快速提升流量" style="border:0;padding:0;margin:0;" />
	</a>
	-->
</div>
<!-- wumii Button END -->

<!-- UJian Button BEGIN -->
<!-- 	<div class="ujian-hook" style="padding-left: 17px;"></div>
	<script type="text/javascript">var ujian_config = {num:6,picSize:83,textHeight:45};</script>
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?uid=1893018"></script>-->
<!-- UJian Button END -->

<!-- baidu tuijian BEGIN -->
<!-- <div id="hm_t_22763"></div> -->
<!-- baidu tuijian BEGIN -->
<!--	<div style="padding-left: 17px;"> -->
<!--		<script src="http://wm.lrswl.com/page/s.php?s=103186&w=640&h=60"></script> -->
<!--	</div> -->




<section id="comment">
  <script>
    var duoshuoQuery = {short_name:"cnliam"};
  </script>
  <script src="http://static.duoshuo.com/embed.js"></script>
  <script type="text/javascript">
    function toggleDuoshuoComments(container, id, url){
      if(jQuery(container).has("div").length>0){
        jQuery(container).empty();
        return;
      }
      var el = document.createElement('div');
      el.setAttribute('class', "ds-thread");//实验参数
      el.setAttribute('data-thread-key', id);//必选参数
      el.setAttribute('data-url', url);//必选参数
      el.setAttribute('data-title', id);//可选参数
      DUOSHUO.EmbedThread(el);
      jQuery(container).append(el);
    }
  </script>
  <h1 class="title">
    <a href="javascript:void(0);" onclick="toggleDuoshuoComments('#comment-box', '在 LaTeX 中进行文学编程', 'http://liam0205.me/2015/01/23/literate-programming-in-latex/');">查看评论</a>
  </h1>
  <div id="comment-box">
    <!-- <div class="ds-thread" data-title="在 LaTeX 中进行文学编程"></div> -->
  </div>
</section>


</div>
  </div>
  <div class="widget-wrapper">
    <aside id="sidebar">
  
  
    
      
      

<div class="widget tag first">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/GRE/">GRE</a><small>4</small></li>
  
    <li><a href="/categories/IT/">IT</a><small>16</small></li>
  
    <li><a href="/categories/LaTeX/">LaTeX</a><small>47</small></li>
  
    <li><a href="/categories/Life/">Life</a><small>3</small></li>
  
    <li><a href="/categories/Literature and Social Sciences/">Literature and Social Sciences</a><small>8</small></li>
  
  </ul>
</div>


    
      
      

<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
  <!--
  <a href="/tags/3000/" style="font-size: 10.00px;">3000</a><a href="/tags/AHD/" style="font-size: 10.00px;">AHD</a><a href="/tags/AMS/" style="font-size: 10.00px;">AMS</a><a href="/tags/AW/" style="font-size: 15.00px;">AW</a><a href="/tags/Apple Dictionaries/" style="font-size: 10.00px;">Apple Dictionaries</a><a href="/tags/Argument/" style="font-size: 10.00px;">Argument</a><a href="/tags/Async Loading/" style="font-size: 10.00px;">Async Loading</a><a href="/tags/BackDoorLock/" style="font-size: 10.00px;">BackDoorLock</a><a href="/tags/Baseline/" style="font-size: 10.00px;">Baseline</a><a href="/tags/Baselineskip/" style="font-size: 10.00px;">Baselineskip</a><a href="/tags/Baselinestretch/" style="font-size: 10.00px;">Baselinestretch</a><a href="/tags/BibTeX/" style="font-size: 10.00px;">BibTeX</a><a href="/tags/Bitmap/" style="font-size: 10.00px;">Bitmap</a><a href="/tags/Blank/" style="font-size: 10.00px;">Blank</a><a href="/tags/Blindness/" style="font-size: 10.00px;">Blindness</a><a href="/tags/Blog/" style="font-size: 10.00px;">Blog</a><a href="/tags/Book review/" style="font-size: 10.00px;">Book review</a><a href="/tags/Bookmarks/" style="font-size: 10.00px;">Bookmarks</a><a href="/tags/CCT/" style="font-size: 10.00px;">CCT</a><a href="/tags/CJK/" style="font-size: 15.00px;">CJK</a><a href="/tags/CamStudio/" style="font-size: 10.00px;">CamStudio</a><a href="/tags/Chapter/" style="font-size: 15.00px;">Chapter</a><a href="/tags/Chinese/" style="font-size: 15.00px;">Chinese</a><a href="/tags/Christianity/" style="font-size: 15.00px;">Christianity</a><a href="/tags/Circled/" style="font-size: 10.00px;">Circled</a><a href="/tags/Compile/" style="font-size: 10.00px;">Compile</a><a href="/tags/Contact/" style="font-size: 10.00px;">Contact</a><a href="/tags/Copy/" style="font-size: 10.00px;">Copy</a><a href="/tags/Damnification/" style="font-size: 10.00px;">Damnification</a><a href="/tags/Definition/" style="font-size: 10.00px;">Definition</a><a href="/tags/Delimiter/" style="font-size: 10.00px;">Delimiter</a><a href="/tags/Demo/" style="font-size: 10.00px;">Demo</a><a href="/tags/Duoshuo/" style="font-size: 10.00px;">Duoshuo</a><a href="/tags/EPS/" style="font-size: 10.00px;">EPS</a><a href="/tags/Encoding/" style="font-size: 10.00px;">Encoding</a><a href="/tags/English/" style="font-size: 20.00px;">English</a><a href="/tags/Environ/" style="font-size: 10.00px;">Environ</a><a href="/tags/Environment/" style="font-size: 10.00px;">Environment</a><a href="/tags/Equation/" style="font-size: 10.00px;">Equation</a><a href="/tags/Equation number/" style="font-size: 10.00px;">Equation number</a>
  -->
  <a href="/tags/AW/" style="font-size: 12.50px;">AW</a><a href="/tags/CJK/" style="font-size: 12.50px;">CJK</a><a href="/tags/Chapter/" style="font-size: 12.50px;">Chapter</a><a href="/tags/Chinese/" style="font-size: 12.50px;">Chinese</a><a href="/tags/Christianity/" style="font-size: 12.50px;">Christianity</a><a href="/tags/English/" style="font-size: 15.00px;">English</a><a href="/tags/Europe/" style="font-size: 15.00px;">Europe</a><a href="/tags/Git/" style="font-size: 12.50px;">Git</a><a href="/tags/Grammar/" style="font-size: 15.00px;">Grammar</a><a href="/tags/Greece/" style="font-size: 12.50px;">Greece</a><a href="/tags/Hexo/" style="font-size: 12.50px;">Hexo</a><a href="/tags/Highlight/" style="font-size: 12.50px;">Highlight</a><a href="/tags/History/" style="font-size: 15.00px;">History</a><a href="/tags/Images/" style="font-size: 12.50px;">Images</a><a href="/tags/Kindle/" style="font-size: 15.00px;">Kindle</a><a href="/tags/LaTeX speech/" style="font-size: 10.00px;">LaTeX speech</a><a href="/tags/Listings/" style="font-size: 12.50px;">Listings</a><a href="/tags/MacTeX/" style="font-size: 12.50px;">MacTeX</a><a href="/tags/Macro/" style="font-size: 12.50px;">Macro</a><a href="/tags/Number/" style="font-size: 10.00px;">Number</a><a href="/tags/Overbrace/" style="font-size: 10.00px;">Overbrace</a><a href="/tags/PDF/" style="font-size: 12.50px;">PDF</a><a href="/tags/PIL/" style="font-size: 12.50px;">PIL</a><a href="/tags/Python/" style="font-size: 20.00px;">Python</a><a href="/tags/Romantic/" style="font-size: 12.50px;">Romantic</a><a href="/tags/Rule/" style="font-size: 10.00px;">Rule</a><a href="/tags/SDU/" style="font-size: 10.00px;">SDU</a><a href="/tags/Section/" style="font-size: 12.50px;">Section</a><a href="/tags/Template/" style="font-size: 17.50px;">Template</a><a href="/tags/Translation/" style="font-size: 12.50px;">Translation</a><a href="/tags/Tutorial/" style="font-size: 12.50px;">Tutorial</a><a href="/tags/Underbrace/" style="font-size: 10.00px;">Underbrace</a><a href="/tags/pTeX/" style="font-size: 15.00px;">pTeX</a>
  </div>
</div>


    
      
      

<div class="widget recent-posts">
  <h3 class="title">最近文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2015/05/07/make-every-equations-in-your-document-upright/">让所有的公式都使用正文直立字体</a>
      </li>
    
      <li>
        <a href="/2015/05/05/pil-tutorial-imagedraw-and-imagefont/">PIL 简明教程 - 在现有的图片上涂涂改改</a>
      </li>
    
      <li>
        <a href="/2015/05/03/tense-of-verb/">英语语法之三：动词时态</a>
      </li>
    
      <li>
        <a href="/2015/05/01/open-editor-after-hexo-new-immediately/">在 hexo new 之后立即打开新建的 Markdown 文稿</a>
      </li>
    
      <li>
        <a href="/2015/04/30/using-font-fallback-to-enhance-the-appreance-on-windows/">使用合适的字体回退机制（Fallback）改善网页在 Windows 平台的字体显示效果</a>
      </li>
    
      <li>
        <a href="/2015/04/29/git-checkout-history-version/">在 Git 中 Checkout 历史版本</a>
      </li>
    
      <li>
        <a href="/2015/04/24/apple-dictionaries-download/">Apple 词典·再要你命 3000 | 美国传统大辞典 | Merriam Webster Collegiate Dict</a>
      </li>
    
  </ul>
</div>


    
  
</aside>
<div class="clearfix"></div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2013 -- 2015 <a href="/">Liam Huang</a>
  <!-- 不蒜计数器 -->
  <span id="busuanzi_container_site_pv">
    | 您是本站第 <span id="busuanzi_value_site_pv" font style="color:white"></span> 位访问者
  </span>
  
</div>
<div class="contents-copyright">
  若无特殊说明，本站所有文章均为原创文章，并遵循 <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.zh_TW" target="_blank">CC BY-SA 3.0 协议</a> 发布
</div>
<!--
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   |
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a> and <a href="http://liam0205.me/" target="_blank">Liam Huang</a>
</div>
-->
<div class="clearfix"></div>
<script src="//dn-lbstatics.qbox.me/lbservice/busuanzi/2.0/busuanzi.mini.js"/>
</script>
</footer>
  <script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["tsina","tqq","renren","fbook","twi","weixin","douban","copy"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","tqq","renren","fbook","twi","weixin","douban","copy"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'cnliam' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>


</body>
</html>